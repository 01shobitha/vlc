#!/bin/sh
# ***************************************************************************
# bootstrap : Set up config.mak
# ***************************************************************************
# Copyright (C) 2003-2009 the VideoLAN team
# $Id$
#
# Authors: Christophe Massiot <massiot@via.ecp.fr>
#          Derk-Jan Hartman <hartman at videolan dot org>
#          Felix Paul Kühne <fkuehne at videolan dot org>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston MA 02110-1301, USA.
# ***************************************************************************

LANG=C
export LANG
set -e
set +x

usage()
{
cat << EOF
usage: $0 [-t target] [-d distro] [-b buildir] [-i installdir]

OPTIONS:
   -t target     Force target to "target"
   -d distro     Force distro to "distro"
   -b buildir    Set build dir to "builddir"
   -i installdir Install to "installdir"
   -h            Show some help
EOF
}

add_makefile_cfg()
{
    echo $1 >> "${config_mak}"
}

error()
{
    echo "[contrib] ERROR: $1"
}

info()
{
    echo "[contrib] $1"
}

ensure_macosx_sdk_presence()
{
    if ! test -e /Developer/SDKs; then
        error "Your Developer Tools' SDKs were not found.\nYou need to add extra symbolic links to /Developer to achieve correctly\nbuilt contribs.\nHave a look at the OSX-Compile-HOWTO for details." >&2
        exit 1
    fi
}

DISTRO=
BUILDDIR=.

while getopts “ht:d:b:i:” OPTION
do
     case $OPTION in
         h)
             usage
             exit 1
             ;;
         t)
             TARGET=$OPTARG
             ;;
         d)
             DISTRO=$OPTARG
             ;;
         b)
             BUILDDIR=$OPTARG
             ;;
         i)
             PREFIX=$OPTARG
             ;;
         ?)
             usage
             exit
             ;;
     esac
done

BUILD=`gcc -dumpmachine`

if test "x$TARGET" = "x"; then
    TARGET="$BUILD"
    info "No target specified, using '$TARGET'"
fi

if test "x$PREFIX" = "x"; then
    PREFIX="`pwd`/hosts/$TARGET"
    info "No install dir specified, using '$PREFIX'"
fi

# Make sure prefix is absolute and existing
mkdir -p "${PREFIX}"
PREFIX=`cd "${PREFIX}" && pwd`

#
# Set up build dir
#

mkdir -p "${BUILDDIR}"

# Install build dir makefile
ln -sf "`pwd`/contrib.mak" "${BUILDDIR}/Makefile"

# Create the 'build-src' folder to build from source
mkdir -p "${BUILDDIR}/build-src"
ln -sf "`pwd`/src/contrib-src.mak" "${BUILDDIR}/build-src/Makefile"
ln -sf "`pwd`/src/packages.mak" "${BUILDDIR}/build-src/packages.mak"
ln -sf "`pwd`/src/Patches" "${BUILDDIR}/build-src/Patches"

# Create config.mak
config_mak="${BUILDDIR}/config.mak"
rm -f "${config_mak}"
{
    echo "# Automatically generated by bootstrap."
    echo "# Make changes if you know what you're doing."
} > "${config_mak}"

# Create distro.mak
distro_mak="${BUILDDIR}/distro.mak"
rm -f "${distro_mak}"
{
    echo "# Automatically generated by bootstrap"
    echo "# Make changes if you know what you're doing."
} > "${distro_mak}"

if test "$TARGET" != "$BUILD"; then
    test -z "$CC"    && CC="${TARGET}-gcc"
    test -z "$CXX"   && CXX="${TARGET}-g++"
    test -z "$LD"    && LD="${TARGET}-ld"
    test -z "$RANLIB"&& RANLIB="${TARGET}-ranlib"
    test -z "$AR"    && AR="${TARGET}-ar"
    test -z "$STRIP" && STRIP="${TARGET}-strip"
fi

case $TARGET in
    *powerpc*|*ppc*)
         ARCH="ppc"
     ;;
    *86_64*)
          ARCH="x86_64"
     ;;
    *86*)
          ARCH="i386"
     ;;
    arm*eabi)
          ARCH="armel"
     ;;
    arm*)
          ARCH="arm"
     ;;
esac
add_makefile_cfg "ARCH = $ARCH"

# Check the HAVE_{OS}
case $TARGET in
    *darwin*)
        add_makefile_cfg "HAVE_DARWIN_OS = 1"
        add_makefile_cfg "HAVE_BSD = 1"
    ;;
    *linux*)
        add_makefile_cfg "HAVE_LINUX = 1"
    ;;
    *bsd*)
        add_makefile_cfg "HAVE_BSD = 1"
    ;;
    *wince*)
        add_makefile_cfg "HAVE_WINCE = 1"
    ;;
esac

case $TARGET in
    ppc-darwin|*-apple-darwin8)
        error "Your version of Mac OS X is too old!"
        error "Compiling and running VLC requires 10.5.x or later"
        exit 1
    ;;
    powerpc-apple-darwin9)
        DISTRO=darwin
        HAVE_DARWIN_9=1
        HAVE_DARWIN_32=1
        SDK_TARGET=10.5

        CFLAGS_TUNING=" -arch ppc -mtune=G4"
        EXTRA_CFLAGS=" -D\${ENVP} -isysroot \${MACOSX_SDK} -mmacosx-version-min=\${SDK_TARGET}"
        EXTRA_LDFLAGS=" -arch ppc -isysroot \${MACOSX_SDK} -mmacosx-version-min=\${SDK_TARGET} -Wl,-syslibroot,\${MACOSX_SDK}"
        CC="/Developer/usr/bin/gcc-4.2"
        CXX="/Developer/usr/bin/g++-4.2"
        LD="ld -arch ppc -syslibroot \${MACOSX_SDK} -mmacosx-version-min=\${SDK_TARGET}"

        add_makefile_cfg "SDK_TARGET = ${SDK_TARGET}"
        add_makefile_cfg "ENVP = MACOSX_DEPLOYMENT_TARGET=${SDK_TARGET}"
        add_makefile_cfg "MACOSX_SDK = /Developer/SDKs/MacOSX10.5.sdk"
        add_makefile_cfg "HAVE_DARWIN_9 = 1"
        add_makefile_cfg "PATH = /bin:/usr/bin:/usr/local/bin:"
        ensure_macosx_sdk_presence
    ;;
    i686-apple-darwin*)
        DISTRO=darwin
        HAVE_DARWIN_9=1
        HAVE_DARWIN_32=1
        SDK_TARGET=10.5

        MIN_LD_VERSION_WITH_TEXT_RELOCATION=81
        if test `ld -v 2> /dev/stdout | sed -E 's/.*ld64-([0-9]+).*/\1/'` -lt ${MIN_LD_VERSION_WITH_TEXT_RELOCATION}; then
            error "Your ld version is unable to compile VLC.\nUpdate to Xcode 3.1 or higher."
            exit 1
        fi

        CFLAGS_TUNING=" -march=prescott -mtune=generic -arch i386 -m32"
        EXTRA_CFLAGS=" -D\${ENVP} -isysroot \${MACOSX_SDK} -mmacosx-version-min=\${SDK_TARGET}"
        EXTRA_LDFLAGS=" -arch i386 -isysroot \${MACOSX_SDK} -Wl,-syslibroot,\${MACOSX_SDK} -mmacosx-version-min=\${SDK_TARGET}"
        CC="/Developer/usr/bin/gcc-4.2"
        CXX="/Developer/usr/bin/g++-4.2"

        add_makefile_cfg "PATH = /bin:/usr/bin:/usr/local/bin"

        add_makefile_cfg "SDK_TARGET = ${SDK_TARGET}"
        add_makefile_cfg "HAVE_DARWIN_OS_ON_INTEL = 1"
        add_makefile_cfg "HAVE_DARWIN_9 = 1"
        add_makefile_cfg "ENVP = MACOSX_DEPLOYMENT_TARGET=${SDK_TARGET}"
        add_makefile_cfg "MACOSX_SDK = /Developer/SDKs/MacOSX10.5.sdk"
        if test $TARGET = "i686-apple-darwin10"; then
            add_makefile_cfg "HAVE_DARWIN_10 = 1"
        fi
        ensure_macosx_sdk_presence
    ;;
    x86_64-apple-darwin*)
        DISTRO=darwin64
        SDK_TARGET=10.5
        HAVE_DARWIN_64=1

        CFLAGS_TUNING=" -march=core2 -mtune=core2 -m64 -arch x86_64"
        EXTRA_CFLAGS=" -D\${ENVP} -isysroot \${MACOSX_SDK} -mmacosx-version-min=\${SDK_TARGET}"
        EXTRA_LDFLAGS=" -arch x86_64 -isysroot \${MACOSX_SDK} -Wl,-syslibroot,\${MACOSX_SDK} -mmacosx-version-min=\${SDK_TARGET}"

        CC="/Developer/usr/bin/gcc-4.2"
        CXX="/Developer/usr/bin/g++-4.2"
        LD="ld"
        RANLIB="ranlib"
        AR="ar"
        STRIP="strip"

        add_makefile_cfg "SDK_TARGET = ${SDK_TARGET}"
        add_makefile_cfg "HAVE_DARWIN_OS_ON_INTEL = 1"
        add_makefile_cfg "HAVE_DARWIN_9 = 1"
        add_makefile_cfg "ENVP = MACOSX_DEPLOYMENT_TARGET=${SDK_TARGET}"
        add_makefile_cfg "MACOSX_SDK = /Developer/SDKs/MacOSX${SDK_TARGET}.sdk"
        add_makefile_cfg "HAVE_DARWIN_64 = 1"
        add_makefile_cfg "PATH = /bin:/usr/bin:/usr/local/bin"
        if test $TARGET = "x86_64-apple-darwin10"; then
            add_makefile_cfg "HAVE_DARWIN_10 = 1"
        fi
        ensure_macosx_sdk_presence
    ;;
    *mingw32ce)
        add_makefile_cfg "PKG_CONFIG_PATH = \$(PREFIX)/lib/pkgconfig"
        EXTRA_CPPFLAGS=" -D_WIN32_WCE=0x0500"
        DISTRO=wince
    ;;
    *64-*mingw*)
        add_makefile_cfg "HAVE_WIN32 = 1"
        add_makefile_cfg "PKG_CONFIG_PATH = \$(PREFIX)/lib/pkgconfig"
        EXTRA_CFLAGS="-O3"
        DISTRO=win64
    ;;
    *mingw32*)
        add_makefile_cfg "PKG_CONFIG_PATH = \$(PREFIX)/lib/pkgconfig"
        EXTRA_CFLAGS=" -O3 -march=i686 -mtune=generic"
        DISTRO=win32
    ;;
    i686-pc-cygwin)
        add_makefile_cfg "HAVE_CYGWIN = 1"
        CC="gcc -mno-cygwin -isystem /usr/include/mingw"
        CXX="g++ -mno-cygwin -isystem /usr/include/mingw"
        TARGET=`$CC -dumpmachine`
        EXTRA_CFLAGS=" -mno-cygwin -isystem /usr/include/mingw"
        EXTRA_CPPFLAGS=" -mno-cygwin -isystem /usr/include/mingw"
        EXTRA_LDFLAGS=" -mno-cygwin"
        add_makefile_cfg "PKG_CONFIG_PATH = \$(PREFIX)/lib/pkgconfig"
        DISTRO=win32
    ;;
    arm-wince-pe)
        add_makefile_cfg "PKG_CONFIG_PATH = \$(PREFIX)/lib/pkgconfig"
        EXTRA_CPPFLAGS=" -D_WIN32_WCE"
        DISTRO=wince
    ;;
    armeb-linux-uclibc)
        add_makefile_cfg "HAVE_UCLIBC = 1"
        add_makefile_cfg "HAVE_BIGENDIAN = 1"
        EXTRA_CFLAGS="-Os -march=armv5 -msoft-float"
    ;;
    arm-none-linux-gnueabi)
        if test -f /etc/maemo_version; then
            DISTRO=maemo
            EXTRA_CFLAGS=" -mcpu=cortex-a8 -mtune=cortex-a8 -march=armv7-a"
            EXTRA_CFLAGS="$EXTRA_CFLAGS -mfpu=neon -mfloat-abi=softfp"
            EXTRA_CFLAGS="$EXTRA_CFLAGS -O3 -fno-tree-vectorize"
        else
            EXTRA_CFLAGS="-msoft-float"
        fi
    ;;
    *86_64*linux*)
        EXTRA_CFLAGS=" -fPIC"
        EXTRA_CPPFLAGS=" -fPIC"
        EXTRA_LDFLAGS=" -L/usr/lib64"
        add_makefile_cfg "LIBRARY_PATH = /usr/lib64"
        add_makefile_cfg "PKG_CONFIG_PATH = /usr/lib64/pkgconfig"
        add_makefile_cfg "PKG_CONFIG_LIBDIR = /usr/lib64/pkgconfig"
    ;;
esac

#
# Fix up the Distro
#

if test -z "${DISTRO}" -a "$TARGET" = "$BUILD"; then
    if test -d "/usr/lib/pkgconfig"; then
        if test -z "$PKG_CONFIG_PATH"; then
            add_makefile_cfg "PKG_CONFIG_PATH = /usr/lib/pkgconfig"
        fi
        if test -z "$PKG_CONFIG_LIBDIR"; then
            add_makefile_cfg "PKG_CONFIG_LIBDIR = /usr/lib/pkgconfig"
        fi
    fi
    # Try to match distribution
    if test -f /etc/fedora-release; then
        DISTRO=fedora
    elif test -f /etc/maemo_version; then
        DISTRO=maemo
    elif test -f /etc/debian_version; then
        # NOTE: check for Debian *after* its derivatives
        DISTRO=debian
    fi
fi

# Default Unix-like systems
test -z "${DISTRO}" && DISTRO=unix

cat src/Distributions/"${DISTRO}".mak >> "${distro_mak}"

#
# Distro specific settings
#

case "$DISTRO" in
  ios)
    if test -z "$IOS_SDK_ROOT"; then
        error "The bootstrap script requires the IOS_SDK_ROOT environment "
        error "variable to be set when building for iOS"
        exit 1
    fi
    add_makefile_cfg "IOS_SDK_ROOT = ${IOS_SDK_ROOT}"
    ;;
esac

# Save passed flags
EXTRA_CFLAGS+=" $CFLAGS"
EXTRA_LDFLAGS+=" $LDFLAGS"
EXTRA_CPPFLAGS+=" $CPPFLAGS"
EXTRA_CXXFLAGS+=" $CXXFLAGS"

uppercase_distro=`echo "$DISTRO" | tr '[:lower:]' '[:upper:]'`
add_makefile_cfg "HAVE_${uppercase_distro} = 1"
add_makefile_cfg "BUILD = $BUILD"
add_makefile_cfg "HOST = $TARGET"
add_makefile_cfg "SRCDIR = `pwd`"
add_makefile_cfg "PREFIX = ${PREFIX}"
add_makefile_cfg "VLCROOTDIR = `pwd`/../.."

ln -sfn hosts/$TARGET build

add_makefile_cfg "CC = ${CC}"
add_makefile_cfg "CXX = ${CXX}"
add_makefile_cfg "LD = ${LD}"
add_makefile_cfg "RANLIB = ${RANLIB}"
add_makefile_cfg "AR = ${AR}"
add_makefile_cfg "STRIP = ${STRIP}"
add_makefile_cfg "EXTRA_CFLAGS = ${CFLAGS_TUNING} ${EXTRA_CFLAGS}"
add_makefile_cfg "EXTRA_CPPFLAGS = ${EXTRA_CPPFLAGS} -isystem \$(PREFIX)/include"
add_makefile_cfg "EXTRA_LDFLAGS = ${EXTRA_LDFLAGS}"
add_makefile_cfg "EXTRA_PATH = ${EXTRA_PATH}"

#CMAKE
if test "$TARGET" != "$BUILD"; then
    toolchain_cmake="${BUILDDIR}/toolchain.cmake"
    if test ${DISTRO} = "win32"; then
        echo "SET(CMAKE_SYSTEM_NAME Windows)" >> "${toolchain_cmake}"
    fi
    echo "SET(CMAKE_C_COMPILER ${CC})" >> "${toolchain_cmake}"
    echo "SET(CMAKE_CXX_COMPILER ${CXX})" >> "${toolchain_cmake}"
    echo "SET(CMAKE_FIND_ROOT_PATH  `pwd` )" >> "${toolchain_cmake}"
    echo "set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)" >> "${toolchain_cmake}"
    echo "set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)" >> "${toolchain_cmake}"
    echo "set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> "${toolchain_cmake}"
fi

if wget --version >/dev/null 2>&1; then
    add_makefile_cfg "WGET = \"`which wget`\" -c --passive"
elif test -z `curl --version >/dev/null 2>&1`; then
    add_makefile_cfg "WGET = \"`which curl`\" -L -O"
else
    error "You need at least wget or curl to fetch the packages."
    exit 1
fi

if svn --version >/dev/null 2>&1; then
    add_makefile_cfg "SVN = \"`which svn`\""
else
    error "You do not have a subversion client in your PATH."
fi

if git --version>/dev/null 2>&1; then
    add_makefile_cfg "GIT = \"`which git`\""
else
    error "You do not have a Git client in your PATH."
fi

if test -z "$CONTRIBS_RELEASE"; then
    add_makefile_cfg "EXTRA_CFLAGS += -DNDEBUG"
    info "*****************************************************************"
    info "* If you need contribs with all debug information, run this     *"
    info "* line and compile the libraries on your own.                   *"
    info "* CONTRIBS_RELEASE=no ./bootstrap                               *"
    info "*****************************************************************"
fi

if test $HAVE_DARWIN_9; then
    if ! /Developer/usr/bin/gcc-4.2 --version>/dev/null 2>&1; then
        error "You do not have GCC-4.2 instelled, compilation WILL FAIL."
    fi
fi

if test $HAVE_DARWIN_32; then
    info "*****************************************************************"
    info "* VLC will be compiled in 32bit mode.                           *"
    info "*                                                               *"
    info "* Re-run with the x86_64-apple-darwin* argument to turn on      *"
    info "* 64bit compilation for Intel-based Macs, whereas * is either   *"
    info "* 9 or 10 depending on your Darwin version.                     *"
    info "* There is NO PPC64 support right now.                          *"
    info "*****************************************************************"
fi

if test $HAVE_DARWIN_64; then
    info
    info "*****************************************************************"
    info "* VLC will be compiled in 64bit mode using the 10.5 SDK.        *"
    info "*****************************************************************"
fi

case `uname` in
    Linux)
        CPUS=`grep -c ^processor /proc/cpuinfo`
     ;;
    Darwin)
        CPUS=`sysctl hw.ncpu|cut -d: -f2`
    ;;
    *)
        CPUS=1  # default
     ;;
esac
add_makefile_cfg "MAKEFLAGS += -j$CPUS"

info "Using $CPUS processor(s)"
