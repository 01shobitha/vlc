#! /bin/sh

##  genmf file for the VLC media player
##
## Copyright (C) 2005-2007 the VideoLAN team
##
##  Authors: Sam Hocevar <sam@zoy.org>
##           RÃ©mi Denis-Courmont <rem # videolan # org>

cd $(dirname "$0")/.. || exit 1

while test "$1"
do
  printf "."
  dir="$1"
  modf="modules/${dir}/Modules.am"
  makf="modules/${dir}/Makefile.am"
  basedir="`echo "${dir}" | cut -f1 -d/`"
  # automake will not recurse for make dist if we don't define SUBDIRS = .
  subdirs="`sed -ne 's,'modules/${dir}'/\([^/]*\)/Makefile,\1,p' configure.ac | xargs`"
  mods="`sed -n -e 's/^ *SOURCES_\([^ ]*\).*/\1/p' < "${modf}" | xargs`"
  extra_ltlibs=""
  for mod in $mods
  do
    extra_ltlibs="${extra_ltlibs} lib${mod}_plugin.la"
  done
  rm -f "${makf}" && cat > "${makf}" << EOF
# ${makf} automatically generated from ${modf} by bootstrap
# DO NOT EDIT - edit Modules.am or \$(top_srcdir)/bootstrap instead

basedir = ${basedir}
dir = ${dir}
mods = ${mods}
SUBDIRS = ${subdirs}
EXTRA_LTLIBRARIES = ${extra_ltlibs}

include \$(top_srcdir)/modules/common.am

EOF
  for mod in $mods
  do
    cat >> m4/private.m4 << EOF
    ${mod}) list="\\\${list} ${dir}/lib${mod}" ;;
EOF
    cat >> "${makf}" << EOF
# The ${mod} plugin
lib${mod}_plugin_la_SOURCES = \$(SOURCES_${mod})
nodist_lib${mod}_plugin_la_SOURCES = \$(nodist_SOURCES_${mod})
lib${mod}_plugin_la_CFLAGS = \$(AM_CFLAGS)
lib${mod}_plugin_la_CXXFLAGS = \$(AM_CXXFLAGS)
lib${mod}_plugin_la_OBJCFLAGS = \$(AM_OBJCFLAGS)
lib${mod}_plugin_la_LIBADD = \$(AM_LIBADD) \\
	\`\$(VLC_CONFIG) -libs plugin ${mod}\`
# Automake does not understand \`...\` very well inside LIBADD...
lib${mod}_plugin_la_DEPENDENCIES = \$(AM_LIBADD)

EOF
  done

  shift
done
printf "\n"
